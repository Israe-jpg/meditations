{% extends "base.html" %}
{% from 'bootstrap4/form.html' import render_form %}

{% block title %}Add Blog Post - Meditations{% endblock %}

{% block content %}
<div class="container mt-10" style="margin-top: 6rem;">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">Add New Blog Post</h3>
                </div>
                <div class="card-body">
                    {{ render_form(form, button_map={'submit': 'btn btn-primary btn-lg mt-3'}) }}
                    {{ ckeditor.load() }}
                    {{ ckeditor.config(name='blog_content') }}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Handle CKEditor data persistence
document.addEventListener('DOMContentLoaded', function() {
    // Wait for CKEditor to be ready
    if (window.CKEDITOR) {
        CKEDITOR.on('instanceReady', function(evt) {
            if (evt.editor.name === 'blog_content') {
                const editor = evt.editor;
                
                // Load saved content when editor is ready
                const savedContent = localStorage.getItem('blog_content_data');
                if (savedContent) {
                    editor.setData(savedContent);
                }
                
                // Save content when it changes
                editor.on('change', function() {
                    localStorage.setItem('blog_content_data', editor.getData());
                });
                
                // Also save on key events for more frequent saving
                editor.on('key', function() {
                    setTimeout(function() {
                        localStorage.setItem('blog_content_data', editor.getData());
                    }, 100);
                });
            }
        });
    }
    
    // Clear saved content when form is successfully submitted
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            // Check if form validation passes by seeing if we redirect
            setTimeout(function() {
                if (window.location.pathname !== '/blog_modal') {
                    // Successfully submitted, clear saved data
                    localStorage.removeItem('blog_content_data');
                }
            }, 100);
        });
    }
});
</script>
{% endblock %}