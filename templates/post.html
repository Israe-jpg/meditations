{% extends "base.html" %}

{% block title %}{{ post.title if post else 'Post' }} - Meditations{% endblock %}

{% block content %}
<!-- Post Content-->
<article class="mb-4">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                {{ page_body | safe }}
            </div>
        </div>
        {% if current_user.role == 'admin' %}
        <a class="btn btn-sm btn-primary text-uppercase" href="{{ url_for('edit_post', id=blog.id) }}" style="font-size: 1.2rem; width: 60px; height: 40px; margin-top: 20px; margin-bottom: 20px; float: right;">Edit</a>
        {% endif %}
    </div>
</article>

<!-- Comments Section -->
<section class="py-5">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                
                <!-- Comment Form (only for logged-in users) -->
                {% if current_user.is_authenticated %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Leave a Comment</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST">
                            {{ comment_form.hidden_tag() }}
                            <div class="mb-3">
                                {{ comment_form.content.label(class="form-label") }}
                                {{ comment_form.content(class="form-control") }}
                                {% for error in comment_form.content.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                            </div>
                            {{ comment_form.submit(class="btn btn-primary") }}
                        </form>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <a href="{{ url_for('login') }}" class="alert-link">Log in</a> to leave a comment.
                </div>
                {% endif %}
                
                <!-- Comments Display -->
                <div class="comments-section">
                    <h4 class="mb-4">Comments ({{ number_of_comments }})</h4>
                    
                    {% if comments %}
                        <div id="comments-container" data-post-id="{{ blog.id }}">
                            {% for comment in comments %}
                            <div class="card mb-3 comment-card" style="position: relative;">
                                <div class="card-body p-3">
                                    
                                    <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px;">
                                        <button type="button" class="btn btn-outline-secondary btn-sm edit-btn" data-content="{{ comment.content }}" data-comment-id="{{ comment.id }}" style="width: 25px; height: 25px; padding: 0; border-radius: 3px; display: flex; align-items: center; justify-content: center;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                                                <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z"></path>
                                            </svg>
                                        </button>
                                        <form method="POST" action="{{ url_for('delete_comment', id=comment.id) }}">
                                            <button type="submit" class="btn btn-outline-secondary btn-sm" 
                                                    onclick="return confirm('Are you sure you want to delete this comment?')"
                                                    style="width: 25px; height: 25px; padding: 0; border-radius: 3px; display: flex; align-items: center; justify-content: center;">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"></path>
                                                    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"></path>
                                                </svg>
                                            </button>
                                        </form>
                                    </div>
                                    
                                    
                                    <div class="d-flex align-items-start mb-2">
                                        <img src="{{ url_for('static', filename=comment.author.profile_picture or 'default_profile.jpg') }}" 
                                             alt="Profile" 
                                             class="me-3"
                                             style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">
                                        <div class="flex-grow-1">
                                            <div class="mb-1">
                                                <small class="fw-bold mb-0">{{ comment.author.name }}</small>
                                            </div>

                                            <!-- Edit form -->
                                            <div id="edit-form-{{ comment.id }}" style="display: none;">
                                                <form method="POST" action="{{ url_for('edit_comment', id=comment.id) }}">
                                                    {{ comment_form.hidden_tag() }}
                                                    <textarea class="form-control mb-2" name="content" rows="3" style="font-size: 0.9rem; resize: vertical;"></textarea>
                                                    <div class="d-flex gap-2">
                                                        <button type="submit" class="btn btn-primary btn-sm">Save</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelEdit('{{ comment.id }}')">Cancel</button>
                                                    </div>
                                                </form>
                                            </div>
                                            <!-- Usual comment display -->
                                            <div id="comment-text-{{ comment.id }}" class="comment-text" style="display: block;">
                                                <p class="mb-0 comment-full" style="font-size: 0.9rem; display: none;">{{ comment.content }}</p>
                                                <p class="mb-0 comment-preview" style="font-size: 0.9rem;">{{ comment.content }}</p>
                                                <a href="#" class="text-primary continue-reading" style="font-size: 0.8rem; display: none;">Continue reading...</a>
                                                <a href="#" class="text-primary show-less" style="font-size: 0.8rem; display: none;">Show less</a>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-muted" style="position: absolute; bottom: 10px; right: 10px;">{{ comment.date }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if number_of_comments > 3 %}
                        <!-- Load More Button-->
                        <div class="d-flex justify-content-center mb-4 mt-4">
                            <button id="load-more-comments-btn" class="btn btn-primary" data-initial-count="{{ comments|length }}">
                                Load More Comments
                            </button>
                        </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">No comments yet. Be the first to comment!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Existing comment functionality (read more, edit, etc.)
document.addEventListener('DOMContentLoaded', function() {
    const maxLines = 6;
    const lineHeight = 20;
    const maxHeight = maxLines * lineHeight;
    
    function initializeCommentText(commentDiv) {
        const previewP = commentDiv.querySelector('.comment-preview');
        const fullP = commentDiv.querySelector('.comment-full');
        const continueBtn = commentDiv.querySelector('.continue-reading');
        const showLessBtn = commentDiv.querySelector('.show-less');
        
        if (previewP && previewP.scrollHeight > maxHeight) {
            previewP.style.maxHeight = maxHeight + 'px';
            previewP.style.overflow = 'hidden';
            previewP.style.position = 'relative';
            previewP.style.background = 'linear-gradient(transparent ' + (maxHeight - 20) + 'px, rgba(255,255,255,0.8) ' + maxHeight + 'px)';
            
            continueBtn.style.display = 'inline';
            
            continueBtn.addEventListener('click', function(e) {
                e.preventDefault();
                previewP.style.display = 'none';
                continueBtn.style.display = 'none';
                fullP.style.display = 'block';
                showLessBtn.style.display = 'inline';
            });
            
            showLessBtn.addEventListener('click', function(e) {
                e.preventDefault();
                fullP.style.display = 'none';
                showLessBtn.style.display = 'none';
                previewP.style.display = 'block';
                continueBtn.style.display = 'inline';
            });
        }
    }
    
    // Initialize existing comments
   
    document.querySelectorAll('.comment-text').forEach(initializeCommentText);
    
    // Load More Comments functionality
    const loadMoreBtn = document.getElementById('load-more-comments-btn');
    if (loadMoreBtn) {
        let currentOffset = parseInt(loadMoreBtn.getAttribute('data-initial-count')) || 3;
        const postId = document.getElementById('comments-container').getAttribute('data-post-id');
        
        loadMoreBtn.addEventListener('click', function() {
            const button = this;
            const originalText = button.textContent;
            
            button.textContent = 'Loading...';
            button.disabled = true;

            fetch(`/load_comments?offset=${currentOffset}&limit=3&post_id=${postId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.comments && data.comments.length > 0) {
                        const commentsContainer = document.getElementById('comments-container');
                        
                        data.comments.forEach(comment => {
                            const commentHtml = createCommentHTML(comment);
                            commentsContainer.insertAdjacentHTML('beforeend', commentHtml);
                            
                            
                            // Add admin buttons for admin users
                            addAdminButtons(comment);
                            
                        });
                        
                        // Initialize comment text functionality for new comments
                        const newComments = commentsContainer.querySelectorAll('.comment-card:nth-last-child(-n+' + data.comments.length + ') .comment-text');
                        newComments.forEach(initializeCommentText);
                        
                        currentOffset += data.comments.length;
                        
                        if (data.has_more) {
                            button.textContent = originalText;
                            button.disabled = false;
                        } else {
                            button.textContent = 'No More Comments';
                            button.disabled = true;
                        }
                    } else {
                        button.textContent = 'No More Comments';
                        button.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    button.textContent = 'Error - Try Again';
                    button.disabled = false;
                });
        });
    }
});

// Function to create comment HTML
function createCommentHTML(comment) {
    return `
        <div class="card mb-3 comment-card" style="position: relative;">
            <div class="card-body p-3">
                <div class="d-flex align-items-start mb-2">
                    <img src="/static/${comment.profile_picture || 'default_profile.jpg'}" 
                         alt="Profile" 
                         class="me-3"
                         style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">
                    <div class="flex-grow-1">
                        <div class="mb-1">
                            <small class="fw-bold mb-0">${comment.author_name}</small>
                        </div>
                        
                        <div id="comment-text-${comment.id}" class="comment-text" style="display: block;">
                            <p class="mb-0 comment-full" style="font-size: 0.9rem; display: none;">${comment.content}</p>
                            <p class="mb-0 comment-preview" style="font-size: 0.9rem;">${comment.content}</p>
                            <a href="#" class="text-primary continue-reading" style="font-size: 0.8rem; display: none;">Continue reading...</a>
                            <a href="#" class="text-primary show-less" style="font-size: 0.8rem; display: none;">Show less</a>
                        </div>
                    </div>
                </div>
                <small class="text-muted" style="position: absolute; bottom: 10px; right: 10px;">${comment.date}</small>
            </div>
        </div>
    `;
}


function addAdminButtons(comment) {
    const commentCard = document.querySelector(`#comment-text-${comment.id}`).closest('.comment-card');
    const cardBody = commentCard.querySelector('.card-body');
    
    // Create admin buttons HTML
    const adminButtonsHTML = `
        <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px;">
            <button type="button" class="btn btn-outline-secondary btn-sm edit-btn" data-content="${comment.content}" data-comment-id="${comment.id}" style="width: 25px; height: 25px; padding: 0; border-radius: 3px; display: flex; align-items: center; justify-content: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                    <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z"></path>
                </svg>
            </button>
            <form method="POST" action="/delete_comment/${comment.id}">
                <button type="submit" class="btn btn-outline-secondary btn-sm" 
                        onclick="return confirm('Are you sure you want to delete this comment?')"
                        style="width: 25px; height: 25px; padding: 0; border-radius: 3px; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"></path>
                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"></path>
                    </svg>
                </button>
            </form>
        </div>
    `;
    
    // Insert admin buttons at the beginning of card-body
    cardBody.insertAdjacentHTML('afterbegin', adminButtonsHTML);
    
    // Add edit form after the comment text div
    const commentTextDiv = commentCard.querySelector(`#comment-text-${comment.id}`);
    const editFormHTML = `
        <div id="edit-form-${comment.id}" style="display: none;">
            <form method="POST" action="/edit_comment/${comment.id}">
                <textarea class="form-control mb-2" name="content" rows="3" style="font-size: 0.9rem; resize: vertical;"></textarea>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-sm">Save</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelEdit('${comment.id}')">Cancel</button>
                </div>
            </form>
        </div>
    `;
    
    commentTextDiv.insertAdjacentHTML('beforebegin', editFormHTML);
}


// Edit comment functionality
document.addEventListener('click', function(e) {
    if (e.target.closest('.edit-btn')) {
        const button = e.target.closest('.edit-btn');
        const commentContent = button.getAttribute('data-content');
        const commentId = button.getAttribute('data-comment-id');
        const commentText = document.getElementById('comment-text-' + commentId);
        const editForm = document.getElementById('edit-form-' + commentId);
        const textarea = editForm.querySelector('textarea');
        
        if (textarea) {
            textarea.value = commentContent;
        }
        
        commentText.style.display = 'none';
        editForm.style.display = 'block';
    }
});

function cancelEdit(commentId) {
    const commentText = document.getElementById('comment-text-' + commentId);
    const editForm = document.getElementById('edit-form-' + commentId);
    
    commentText.style.display = 'block';
    editForm.style.display = 'none';
}
</script>

{% endblock %}